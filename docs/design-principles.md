# 認証基盤 設計思想

## 概要

マイクロサービスアーキテクチャにおける認証・認可の中央基盤として、全サービスに共通する認証機能を提供する。

## 基本原則

### 1. 認証は横断的関心事（Cross-Cutting Concern）である

認証・認可は特定のビジネスドメインに属さない「インフラ層」の責務である。特定のサービスに認証機能を持たせると、以下の問題が発生する：

- ドメインロジックと認証ロジックの混在
- 変更・拡張の困難さ
- 責務の曖昧さ

### 2. 既存サービスへの依存を避ける

既存サービスの認証機能をinternal APIで参照する方式は採用しない。

**理由：**

- **単一障害点**: そのサービスが停止すると全サービスの認証が止まる
- **リリースサイクルの結合**: 認証の変更が特定サービスのリリースに縛られる
- **責務の曖昧さ**: 「本業 + 認証基盤」という二重責務を負う
- **スケーリング特性の違い**: 認証トラフィックとビジネストラフィックは異なるパターンを持つ

### 3. Single Source of Truth

ユーザー、テナント、共通ロールの情報は認証基盤に集約する。各サービスで同じ情報を重複して持たない。

```
認証基盤が管理するもの：
├── ユーザー情報（ID, メール, 名前, etc.）
├── テナント情報（テナントID, 名前, プラン, etc.）
└── 共通ロール（admin, member, viewer など）

各サービスが管理するもの：
├── user_id（認証基盤への参照）
├── サービス固有の権限（必要な場合のみ）
└── 業務データ
```

## 認証・認可の設計

### JWT（JSON Web Token）ベースの認証

各サービスが認証基盤に問い合わせることなく、トークンの検証のみで認証を完結できる設計とする。

```
┌─────────────────────────────────────────────┐
│           認証基盤（IdP）                     │
│   ・ログイン/ログアウト                        │
│   ・トークン発行 (JWT)                        │
│   ・ユーザー管理                              │
│   ・テナント管理                              │
│   ・共通ロール管理                            │
└─────────────────────────────────────────────┘
              │ JWT発行
              ▼
┌─────────┐  ┌─────────┐  ┌─────────┐
│Service A│  │Service B│  │Service C│
│(検証のみ)│  │(検証のみ)│  │(検証のみ)│
└─────────┘  └─────────┘  └─────────┘
```

### JWTに含める情報

```json
{
  "sub": "user-uuid-12345",
  "tenant_id": "tenant-uuid",
  "roles": ["admin", "member"],
  "iss": "https://auth.example.com",
  "aud": "https://api.example.com",
  "iat": 1234567890,
  "exp": 1234571490
}
```

| 情報 | 含める | 理由 |
|------|--------|------|
| ユーザーID (sub) | ○ | 必須。各サービスでユーザー特定に使用 |
| テナントID | ○ | マルチテナント対応 |
| 共通ロール | ○ | 変更頻度が低く、全サービスで参照 |
| 基本属性（名前等） | △ | 必要最小限に |
| サービス固有権限 | ✕ | 各サービス側で管理 |
| 機密情報 | ✕ | JWTは署名されるが暗号化されない |

### 共通ロールの考え方

抽象的なロールを定義し、具体的な意味は各サービスが解釈する。

```
共通ロール例：
├── admin    → 各サービスで「管理者権限」として解釈
├── member   → 各サービスで「一般ユーザー権限」として解釈
└── viewer   → 各サービスで「閲覧のみ権限」として解釈
```

サービス固有の細かい権限（例：「この記事は編集できるがあの記事はできない」）は、各サービス側でユーザーIDを使って判断する。

### トークン戦略

- **Access Token**: 短命（15分〜1時間）
- **Refresh Token**: 長命（7日〜30日）、DBで管理し無効化可能

Access Tokenを短命にすることで、ロール変更の反映遅延を許容範囲に抑える。

## マルチテナント

テナント情報は認証基盤で一元管理する。各サービスはJWTに含まれる `tenant_id` を使用してテナントを識別する。

## 将来の拡張

以下の機能は、基盤の安定後に段階的に追加する：

- OAuth連携（Google, GitHub等）
- MFA（多要素認証）
- SSO（シングルサインオン）
- 監査ログ
